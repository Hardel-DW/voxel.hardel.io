---
import { cn } from "@/lib/utils";
import type { HTMLAttributes } from "astro/types";

interface Props extends HTMLAttributes<"div"> {
    numberOfSlides: number;
    direction: "vertical" | "horizontal";
}

const { numberOfSlides, direction, ...props } = Astro.props;
---

<div data-slides
     class={cn("flex gap-2 transition-opacity duration-300", props.class, direction === "vertical" ? "flex-col" : "flex-row")}
     {...props}>
    {Array.from({length: numberOfSlides}).map((_, index) => (
            <div
                    class={cn("rounded-full bg-white/50 cursor-pointer overflow-hidden transition-all duration-300",
                        direction === "vertical" ? "h-6 w-2" : "h-2 w-6"
                    )}
                    data-index={index}
                    data-pagination
            >
                <div
                        class={cn("h-full w-full rounded-full bg-pink-700 transform opacity-100",
                            direction === "vertical" ? "origin-top" : "origin-left"
                        )}
                        data-progress
                ></div>
            </div>
    ))}
</div>

<script>
    class Slider {
        private currentSlide = 0;
        private slideInterval: ReturnType<typeof setInterval> | undefined;
        private readonly direction: string;
        private readonly interval: number;
        private readonly paginationItems: NodeListOf<Element>;
        private readonly slidesCount: number;

        constructor(direction: string, interval: number) {
            this.direction = direction;
            this.interval = interval;
            this.paginationItems = document.querySelectorAll('[data-pagination]');
            this.slidesCount = this.paginationItems.length;
            this.init();
        }

        private init() {
            this.addEventListeners();
            this.startSlideshow();
            this.handleScroll();
        }

        private updatePagination(index: number) {
            for (const [i, paginationItem] of Array.from(this.paginationItems).entries()) {
                const progressBar = paginationItem.querySelector('[data-progress]') as HTMLElement;
                if (!progressBar) continue;

                // Reset styles
                progressBar.style.transition = 'none';
                this.direction === "vertical"
                    ? progressBar.style.transform = 'scaleY(0)'
                    : progressBar.style.transform = 'scaleX(0)';
                progressBar.style.opacity = '1';

                // Update sizes
                if (i === index) {
                    const item = paginationItem as HTMLElement;
                    if (this.direction === "vertical") {
                        item.style.height = '4rem';
                    } else {
                        item.style.width = '4rem';
                    }

                    // Force reflow
                    void progressBar.offsetWidth;

                    progressBar.style.transition = 'transform 5s linear, opacity 0.3s linear 4.7s';
                    this.direction === "vertical"
                        ? progressBar.style.transform = 'scaleY(1)'
                        : progressBar.style.transform = 'scaleX(1)';
                    progressBar.style.opacity = '0';
                } else {
                    const item = paginationItem as HTMLElement;
                    if (this.direction === "vertical") {
                        item.style.height = '1.5rem';
                    } else {
                        item.style.width = '1.5rem';
                    }
                }
            }
        }

        private nextSlide() {
            this.currentSlide = (this.currentSlide + 1) % this.slidesCount;
            this.showSlide();
        }

        private showSlide() {
            this.updatePagination(this.currentSlide);
            window.dispatchEvent(new CustomEvent('onSlideChange', {
                detail: {index: this.currentSlide}
            }));
        }

        private startSlideshow() {
            this.showSlide();
            this.slideInterval = setInterval(() => this.nextSlide(), this.interval);
        }

        private addEventListeners() {
            for (const [i, item] of Array.from(this.paginationItems).entries()) {
                item.addEventListener('click', () => {
                    if (this.slideInterval) {
                        clearInterval(this.slideInterval);
                    }
                    this.currentSlide = i;
                    this.showSlide();
                    this.slideInterval = setInterval(() => this.nextSlide(), this.interval);
                });
            }
        }

        private handleScroll() {
            const slidesElement = document.querySelector('[data-slides]');
            if (!slidesElement) return;
            const scrollThreshold = 50;

            window.addEventListener('scroll', () => {
                const currentScroll = window.scrollY;

                if (currentScroll > scrollThreshold) {
                    slidesElement.classList.add('opacity-0');
                    slidesElement.classList.add('pointer-events-none');
                } else {
                    slidesElement.classList.remove('opacity-0');
                    slidesElement.classList.remove('pointer-events-none');
                }
            });
        }
    }

    // Initialise le slider
    new Slider(
        document.querySelector('[data-pagination]')?.closest('[data-direction]')?.getAttribute('data-direction') || 'horizontal',
        Number(document.querySelector('[data-pagination]')?.closest('[data-interval]')?.getAttribute('data-interval')) || 5000
    );
</script>