---
import { Picture } from "astro:assets";
import { getCollection } from "astro:content";
import CompoundLayout from "@/components/layouts/CompoundLayout.astro";
import Button from "@/components/ui/button.astro";
import ShiningStars from "@/components/ui/pattern/ShiningStars.astro";
import { getTranslations, names } from "@/lib/i18n";
import type { PaginateFunction } from "astro";

export const prerender = true;
const { lang, translate } = await getTranslations(Astro.url);
export async function getStaticPaths({
    paginate
}: {
    paginate: PaginateFunction;
}) {
    const PAGE_SIZE = 9;
    const allPosts = await getCollection("blog", ({ data }) => {
        return !data.draft && data.publishDate < new Date();
    });

    const allSortedPosts = allPosts.sort((a, b) => {
        return b.data.publishDate.valueOf() - a.data.publishDate.valueOf();
    });

    return names.flatMap((i18n) => {
        return paginate(
            allSortedPosts.filter((post) => post.slug.split("/")[0] === i18n.lang),
            {
                pageSize: PAGE_SIZE,
                params: {
                    lang: i18n.lang
                }
            }
        );
    });
}

const { page } = Astro.props;
---

<CompoundLayout title="Blog">
    <div>
        <div class="fixed inset-0 -z-10">
            <ShiningStars/>
        </div>

        <section class="w-full md:w-3/4 max-w-screen-xl mx-auto px-8 mt-32 md:mt-40">
            <h1 class="text-3xl lg:text-6xl lg:tracking-tight mt-1 lg:leading-tight">
                {translate["blog.latest"]}
            </h1>

            <div class="h-1 w-full bg-zinc-700 rounded-full mt-2"/>
        </section>

        <section class="max-w-screen-xl mx-auto px-8 mt-16">
            <ul class="grid sm:grid-cols-2 md:grid-cols-3 gap-10 lg:gap-16">
                {page.data.map((post, index) => (
                        <li class="relative group">
                            <div class="absolute -z-10 size-full inset-0 bg-gradient-to-r from-pink-900 to-blue-900 opacity-30 rounded-full blur-[5rem]"/>

                            <a href={`/${lang}/blog/${post.slug.split("/")[1]}`}>
                                <div class="relative">
                                    <div class="relative overflow-hidden rounded-md"
                                         style={{width: 800, height: 600}}>
                                        <div class="border-line"/>

                                        <Picture
                                                formats={["avif", "webp"]}
                                                src={post.data.image.src}
                                                alt={post.data.image.alt}
                                                sizes="(max-width: 800px) 100vw, 800px"
                                                width={800}
                                                height={600}
                                                loading={index <= 2 ? "eager" : "lazy"}
                                                decoding={index <= 2 ? "sync" : "async"}
                                                class="w-full rounded-md object-cover group-hover:scale-125 transition duration-500"
                                                transition:name={`post-img-${post.slug}`}
                                        />
                                    </div>

                                    <div class="mt-4">
                                        <span class="text-blue-400 uppercase tracking-wider text-xs font-medium">
                                          {post.data.category}
                                        </span>

                                        <h2 class="text-xl font-semibold leading-snug tracking-tight mt-1">
                                            {post.data.title}
                                        </h2>

                                        <div class="flex gap-2 mt-3 text-sm">
                                            <time class="text-gray-400" datetime={post.data.publishDate.toISOString()}>
                                                {Intl.DateTimeFormat(lang, {
                                                    year: "numeric",
                                                    month: "long",
                                                    day: "numeric"
                                                }).format(post.data.publishDate)}
                                            </time>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        </li>
                ))}
            </ul>
        </section>

        <section class="max-w-screen-xl mx-auto px-8 mt-16">
            <div class="flex justify-center items-center mt-10 gap-4">
                {page.url.prev && (
                        <Button variant="primary" href={page.url.prev}>
                            &larr; {translate["blog.previous"]}
                        </Button>
                )}
                {page.url.next && (
                        <Button variant="primary" href={page.url.next}>
                            {translate["blog.next"]} &rarr;
                        </Button>
                )}
            </div>
        </section>
    </div>
</CompoundLayout>